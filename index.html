<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ocean GenAI — Agentic RAG (HTML)</title>
  <style>
    :root{--bg:#0b1020;--card:#0f1724;--muted:#9aa4b2;--accent:#3aa0ff;--glass:rgba(255,255,255,0.03)}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#e6eef6}
    .app{display:flex;flex-direction:column;min-height:100vh}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent)}
    .logo{font-weight:700}
    .main{display:grid;grid-template-columns:320px 1fr 360px;gap:18px;padding:20px}
    .card{background:linear-gradient(180deg,var(--card),rgba(255,255,255,0.02));padding:12px;border-radius:12px}
    .doc-list{max-height:240px;overflow:auto;margin-top:10px}
    .doc{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);margin-bottom:8px;background:var(--glass)}
    .chat-window{height:320px;overflow:auto;padding:8px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
    .chat-message{margin-bottom:8px}
    .chat-input{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);width:100%}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#6db8ff);border:none;color:#001422}
    .center{text-align:center;color:var(--muted)}
    pre.code{background:#071726;padding:12px;border-radius:8px;color:#bfe4ff;overflow:auto}
    .status-Pending{color:var(--muted)}
    .status-Analyzing{color:#ffd166}
    .status-Completed{color:#a3ffb0}
    @media (max-width:1100px){ .main{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">Ocean GenAI</div>
      <div>
        <label title="Toggle theme"><input id="theme" type="checkbox" checked /></label>
        <button id="signin" class="btn">Sign In</button>
      </div>
    </header>

    <main class="main">
      <!-- LEFT: Inputs -->
      <aside class="card">
        <h3>Data Ingestion</h3>

        <label>Upload Documents (max 5)</label><br/>
        <input id="file-input" type="file" multiple /><br/>

        <label style="display:block;margin-top:10px">Scrape URLs (comma separated)</label>
        <input id="scrape-urls" class="chat-input" placeholder="https://..." />
        <div style="margin-top:8px;">
          <button id="btn-scrape" class="btn">Scrape</button>
        </div>

        <div style="margin-top:12px">
          <button id="btn-submit" class="btn primary">Submit Documents for Analysis</button>
        </div>

        <hr/>

        <h4>Document Analysis</h4>
        <input id="filter" class="chat-input" placeholder="Filter documents..." />
        <div id="doc-list" class="doc-list">
          <p class="center">No documents uploaded.</p>
        </div>

        <hr/>
        <h4>Output Actions</h4>
        <button id="btn-download" class="btn">Download Output Zip</button>
        <button id="btn-push" class="btn">Push to Global Memory</button>
      </aside>

      <!-- MIDDLE: Chat & Sources -->
      <section>
        <div class="card">
          <h3>Sources</h3>
          <p id="sources" class="center">No analysis available yet.</p>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Agent Answer</h3>
          <div id="chat" class="chat-window"></div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="chat-input" class="chat-input" placeholder="Ask a question about your documents..." />
            <button id="btn-send" class="btn primary">Send</button>
          </div>
        </div>
      </section>

      <!-- RIGHT: Output -->
      <aside class="card">
        <h3>Agent Output</h3>
        <div>
          <button class="btn tab" data-tab="preview">Preview</button>
          <button class="btn tab" data-tab="code">Code</button>
          <button class="btn tab" data-tab="visual">Visual</button>
        </div>

        <div id="preview" style="margin-top:12px">
          <h4>News</h4>
          <ul id="news"></ul>
        </div>

        <div id="code" style="display:none;margin-top:12px">
          <pre class="code" id="code-block"></pre>
        </div>

        <div id="visual" style="display:none;margin-top:12px">
          <div class="center">Chart placeholder</div>
        </div>
      </aside>
    </main>
  </div>

<script>
/*
  index.html — Vanilla JS frontend for pss.py backend.
  - Set API_BASE below to your running backend (where pss.py serves HTTP).
  - The backend needs to expose:
      POST   /api/upload       (multipart form field 'files')
      GET    /api/job_status?job_id=...
      POST   /api/scrape       (JSON { urls: [...] })
      POST   /api/ask          (JSON { question: "..." })
      GET    /api/download     (returns submission.zip)
      POST   /api/push_memory  (optional body)
  If pss.py does not currently expose these endpoints, create a thin wrapper (FastAPI/Flask)
  that calls the functions inside pss.py and exposes these endpoints. This HTML does not
  require React and works purely via fetch/XHR.
*/

// ===== CONFIG =====
const API_BASE = location.origin + '/api'; // change to your backend URL, e.g. 'http://localhost:8000'
const MAX_FILES = 5;
const POLL_INTERVAL = 2000; // ms

// ===== DOM =====
const fileInput = document.getElementById('file-input');
const btnSubmit = document.getElementById('btn-submit');
const docList = document.getElementById('doc-list');
const filterInput = document.getElementById('filter');
const btnScrape = document.getElementById('btn-scrape');
const scrapeUrls = document.getElementById('scrape-urls');
const chat = document.getElementById('chat');
const chatInput = document.getElementById('chat-input');
const btnSend = document.getElementById('btn-send');
const btnDownload = document.getElementById('btn-download');
const btnPush = document.getElementById('btn-push');
const newsList = document.getElementById('news');
const codeBlock = document.getElementById('code-block');

let selectedFiles = [];
let analysisResults = []; // { name, status, summary }
let currentJobId = null;

// sample code + preview
codeBlock.textContent = `// Example: no server-side changes required
function generateReport(results) {
  let summary = '';
  results.forEach(r => summary += \`- \${r.name}: \${r.summary}\\n\`);
  return summary;
}
`;
const previewNews = [
  "Global markets rally on economic optimism",
  "New AI breakthrough announced in healthcare",
  "Climate summit yields landmark agreements"
];
previewNews.forEach(n => {
  const li = document.createElement('li'); li.textContent = n; newsList.appendChild(li);
});

// ===== helpers =====
function el(tag, props={}, ...children){
  const e = document.createElement(tag);
  for(const k in props) e[k] = props[k];
  for(const c of children) if(typeof c==='string') e.appendChild(document.createTextNode(c)); else e.appendChild(c);
  return e;
}
function setLoading(btn, on, text) {
  if(!btn) return;
  if(on){ btn.disabled=true; btn.dataset.orig=btn.innerText; btn.innerText = text || 'Working...'; }
  else { btn.disabled=false; btn.innerText = btn.dataset.orig || btn.innerText; }
}
function appendChat(sender, text){
  const wrapper = el('div', { className: 'chat-message ' + (sender) });
  const tag = el('div', { style: 'font-weight:600;margin-bottom:4px' }, sender==='user' ? 'You' : (sender==='system' ? 'System' : 'OceanGenAI'));
  const msg = el('div', {}, text);
  wrapper.appendChild(tag); wrapper.appendChild(msg);
  chat.appendChild(wrapper);
  chat.scrollTop = chat.scrollHeight;
}

// ===== UI RENDER =====
function renderDocList(){
  const filter = filterInput.value.toLowerCase();
  docList.innerHTML = '';
  const files = selectedFiles.filter(f => f.name.toLowerCase().includes(filter));
  if(files.length === 0){
    docList.appendChild(el('p',{className:'center'}, 'No documents uploaded.'));
    return;
  }
  files.forEach((f, idx) => {
    const meta = analysisResults.find(a => a.name === f.name) || { status:'Pending', summary:'' };
    const card = el('div', { className: 'doc' });
    const title = el('div', { style: 'font-weight:600' }, f.name);
    const info = el('div', { style:'font-size:12px;color:var(--muted)' }, `${(f.size/1024).toFixed(1)} KB — `, el('span',{ className: 'status-' + meta.status }, meta.status));
    const rem = el('button', { className:'btn', onclick: ()=>{ selectedFiles.splice(idx,1); renderDocList(); } }, 'Remove');
    card.appendChild(title); card.appendChild(info); card.appendChild(el('div', { style:'margin-top:8px' }, rem));
    if(meta.status === 'Completed' && meta.summary){
      card.appendChild(el('div', { style:'margin-top:8px;color:var(--muted);font-size:13px' }, meta.summary));
    }
    docList.appendChild(card);
  });
}

// ===== Events =====
fileInput.addEventListener('change', (e) => {
  selectedFiles = Array.from(e.target.files).slice(0, MAX_FILES);
  // reset analysisResults for new files
  analysisResults = selectedFiles.map(f => ({ name: f.name, status: 'Pending', summary: '' }));
  renderDocList();
});

filterInput.addEventListener('input', renderDocList);

btnSubmit.addEventListener('click', async () => {
  if(!selectedFiles.length){ alert('Select files first'); return; }
  const fd = new FormData();
  selectedFiles.forEach(f => fd.append('files', f));

  try{
    setLoading(btnSubmit, true, 'Uploading...');
    const res = await fetch(API_BASE + '/upload', { method:'POST', body: fd });
    if(!res.ok) throw new Error(await res.text());
    const data = await res.json();
    // expect { job_id, files:[{name, id}], status:'started' }
    currentJobId = data.job_id || null;
    analysisResults = (data.files || selectedFiles.map(f=>({name:f.name,status:'Analyzing'}))).map(x => ({ name: x.name, status: 'Analyzing', summary: '' }));
    renderDocList();
    if(currentJobId) pollJob(currentJobId);
  }catch(err){
    alert('Upload failed: ' + err.message);
    console.error(err);
  }finally{ setLoading(btnSubmit, false); }
});

async function pollJob(jobId){
  if(!jobId) return;
  const poll = setInterval(async () => {
    try{
      const res = await fetch(API_BASE + '/job_status?job_id=' + encodeURIComponent(jobId));
      if(!res.ok) throw new Error(await res.text());
      const data = await res.json();
      // expect: { status: 'running'|'done', files: [{ name, status, summary }] }
      if(data.files){
        analysisResults = data.files.map(f => ({ name: f.name, status: f.status || 'Completed', summary: f.summary || '' }));
        renderDocList();
      }
      if(data.status === 'done' || data.status === 'completed') {
        clearInterval(poll);
        appendChat('system', 'Ingestion completed.');
      }
    }catch(err){
      console.error('poll error', err);
      clearInterval(poll);
    }
  }, POLL_INTERVAL);
}

btnScrape.addEventListener('click', async ()=>{
  const value = scrapeUrls.value.trim();
  if(!value) return alert('Enter one or more URLs.');
  try{
    setLoading(btnScrape, true, 'Scraping...');
    const res = await fetch(API_BASE + '/scrape', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ urls: value.split(',').map(s=>s.trim()) })});
    if(!res.ok) throw new Error(await res.text());
    const data = await res.json();
    appendChat('system', 'Scrape started' + (data.job_id ? ' (job: ' + data.job_id + ')' : ''));
    if(data.job_id) pollJob(data.job_id);
  }catch(err){ alert('Scrape failed: ' + err.message); } finally{ setLoading(btnScrape, false); }
});

btnSend.addEventListener('click', async ()=>{
  const q = chatInput.value.trim(); if(!q) return;
  appendChat('user', q); chatInput.value='';
  try{
    setLoading(btnSend, true, 'Thinking...');
    const res = await fetch(API_BASE + '/ask', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ question: q })});
    if(!res.ok) throw new Error(await res.text());
    const data = await res.json();
    // expect { answer: "..." }
    appendChat('bot', data.answer || data.response || 'No answer returned');
  }catch(err){
    appendChat('bot', 'Error: ' + err.message);
    console.error(err);
  }finally{ setLoading(btnSend, false); }
});

btnDownload.addEventListener('click', async () => {
  try{
    setLoading(btnDownload, true, 'Preparing...');
    const res = await fetch(API_BASE + '/download');
    if(!res.ok) throw new Error('Download failed: ' + res.statusText);
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'submission.zip'; document.body.appendChild(a); a.click(); a.remove();
  }catch(err){ alert('Download error: ' + err.message); } finally{ setLoading(btnDownload, false); }
});

btnPush.addEventListener('click', async () => {
  try{
    setLoading(btnPush, true, 'Pushing...');
    const res = await fetch(API_BASE + '/push_memory', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({})});
    if(!res.ok) throw new Error(await res.text());
    const data = await res.json();
    alert('Pushed to memory: ' + (data.status || 'ok'));
  }catch(err){ alert('Push failed: ' + err.message); } finally{ setLoading(btnPush, false); }
});

// keyboard enter to send
chatInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter') btnSend.click(); });

// sample system message
appendChat('system', 'Ask a question to start the RAG process.');

// Tabs (preview / code / visual)
document.querySelectorAll('.tab').forEach(b=>{
  b.addEventListener('click', ()=>{
    document.getElementById('preview').style.display = b.dataset.tab === 'preview' ? 'block' : 'none';
    document.getElementById('code').style.display = b.dataset.tab === 'code' ? 'block' : 'none';
    document.getElementById('visual').style.display = b.dataset.tab === 'visual' ? 'block' : 'none';
  });
});

</script>
</body>
</html>
